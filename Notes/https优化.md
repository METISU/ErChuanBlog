# HTTPSä¼˜åŒ–

è¿‘æœŸå¤„ç†äº†ä¸€äº›ç½‘ç»œåº“çš„é—®é¢˜ï¼Œå‘ç°æœ‰äº›å‚¨å¤‡çš„çŸ¥è¯†å·²ç»é—å¿˜ï¼Œæœ‰æ€è·¯ä½†æ˜¯å…·ä½“å®ç°è¿˜å¾—ç¿»ä¸€äº›åšå®¢ï¼Œè¿™ç¯‡æ–‡ç« ä¸»è¦ç»™è‡ªå·±åšä¸ªå¤‡å¿˜å½•åŠŸèƒ½ï¼Œæ•´ç†ä¸€ä¸‹ä»¥å‰æ¢ç©¶è¿‡çš„HTTPSç›¸å…³çš„ä¼˜åŒ–ï¼Œå¦‚æœ‰æ›´å¥½çš„æ–¹æ¡ˆï¼Œå¯ä»¥ä¸€èµ·æ¢è®¨ğŸ¥º

## DNSç¼“å­˜

å‘èµ·ä¸€ä¸ªhpptè¯·æ±‚ï¼Œç¬¬ä¸€æ­¥è¦åšçš„å°±æ˜¯DNSè§£æï¼ˆåº”ç”¨å±‚æ–¹é¢ï¼‰ï¼Œè¿™æ—¶å€™è®¡ç®—æœºæœ€å¸¸ç”¨çš„ä¼˜åŒ–æ‰‹æ®µä¹‹ä¸€ï¼šç¼“å­˜å°±æ´¾ä¸Šç”¨åœºäº†ã€‚

æ€è·¯ä¸éš¾ç†è§£ï¼Œé‡è¦çš„æ˜¯ä½¿ç”¨è¿‡ç¨‹ä¸­ä¸å‡ºé—®é¢˜ï¼Œå‡ ä¸ªå…³é”®äº‹é¡¹ï¼š

* ç¼“å­˜çš„æœ‰æ•ˆæœŸ
* ç¼“å­˜æ˜¯å¦å¤±æ•ˆ
* ç¼“å­˜å¤±æ•ˆæˆ–è€…æ²¡æœ‰ç¼“å­˜çš„é™çº§æ–¹æ¡ˆ

ä»»ä½•ä¸œè¥¿æœ€æ³¨é‡çš„æ˜¯ç”¨æˆ·ä½“éªŒï¼Œæˆ‘ä»¬æ·»åŠ ç¼“å­˜çš„ç›®çš„æ˜¯ä¸ºäº†æå‡ç”¨æˆ·ä½“éªŒï¼ˆå“åº”é€Ÿåº¦æ›´å¿«ï¼‰ï¼Œæ‰€ä»¥å¦‚æœç¼“å­˜å‡ºç°é—®é¢˜å¯¼è‡´ç”¨æˆ·è®¿é—®ä¸äº†ï¼Œé‚£æ¯”ç½‘ç»œæ…¢çš„ä½“éªŒè¿˜å·®ï¼Œæ‰€ä»¥é™çº§æ–¹æ¡ˆå¿…é¡»å…ˆè€ƒè™‘å‘¨å…¨

å¤§ä½“æµç¨‹ä¸Šï¼š

![DNSç¼“å­˜](https://user-images.githubusercontent.com/22512175/148319012-80643741-fbc9-433b-a503-069e657e8cf8.png)
  
ä¸»è¦çš„å…³é”®ç‚¹åœ¨äºä¿è¯é™çº§æ–¹æ¡ˆçš„æ­£å¸¸å®è¡Œï¼Œæ¯”å¦‚ç¼“å­˜è¿‡æœŸäº†ã€å¤±æ•ˆç­‰ï¼Œå…·ä½“çš„é—®é¢˜éœ€è¦å…·ä½“åˆ†æ

## Cache-Control

è¿™ä¸ªä¸ç”¨è¿‡å¤šæè¿°äº†ï¼Œåªè¦æ³¨æ„çš„æ˜¯ä¸€äº›ç•Œé¢ä¸èƒ½ä½¿ç”¨ç¼“å­˜ï¼Œæ¯”å¦‚ç§’æ€ç•Œé¢

å¯¹äºä¸€äº›æ¯”è¾ƒå¤§çš„æ•°æ®é‡è¦æ£€æŸ¥æ˜¯å¦è¦æ›´æ–°ç¼“å­˜æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ **if-Modified-Since**ã€**If-None-Match** å­—æ®µï¼Œå¦‚æœè¿”å› **304 Not Modified**ï¼Œåˆ™ä»£è¡¨ä¸éœ€è¦æ›´æ–°ç¼“å­˜ï¼ŒèŠ‚çœæµé‡ä»¥åŠæ—¶é—´

## SSL/TLS

TLSæ˜¯ä»€ä¹ˆå°±ä¸è¿‡å¤šè¿°äº†ï¼Œä¸‹é¢ä¸»è¦è®²äº›TLSä¸Šé¢çš„ä¼˜åŒ–

é¦–å…ˆè¿‡ä¸€ä¸‹ä¼ ç»Ÿçš„RSAç®—æ³•æ¡æ‰‹è¿‡ç¨‹ï¼š

1. client to service: éšæœºæ•°ã€tlsç‰ˆæœ¬ã€å¯†ç å¥—ä»¶ç­‰å¿…è¦ä¿¡æ¯
2. service to client: éšæœºæ•°ã€ä½¿ç”¨çš„å¯†ç å¥—ä»¶ã€è¯ä¹¦
3. clienté¡ºç€è¯ä¹¦é“¾éªŒè¯è¯ä¹¦æœ‰æ•ˆï¼Œclient to service: å…¬é’¥åŠ å¯†**Pre-Master**ï¼ˆç¬¬ä¸‰ä¸ªéšæœºæ•°ï¼‰ï¼Œå‘é€ç»™æœåŠ¡ç«¯ï¼ŒåŒæ—¶clientå·²ç»æœ‰3ä¸ªéšæœºæ•°ï¼Œå¯ä»¥ç”Ÿæˆå¯¹ç§°åŠ å¯†ç§˜é’¥
4. service to client: æ‹¥æœ‰3ä¸ªéšæœºæ•°ï¼Œç¡®è®¤ç§˜é’¥ï¼Œä¹‹åä½¿ç”¨ç§˜é’¥åŠ å¯†ä¼ è¾“

å¯è§ä¸€ä¸ªå®Œæˆçš„TLSè¿æ¥éœ€è¦è€—è´¹2 RTTï¼Œå¯ä»¥çœ‹çœ‹å»ºç«‹ä¸€ä¸ªHTTPSè¿æ¥å„ä¸ªæµç¨‹æ‰€èŠ±è´¹çš„æ—¶é—´

``` shell
curl -o /dev/null -s -w "time_namelookup: %{time_namelookup}\ntime_connect: %{time_connect}\ntime_appconnect: %{time_appconnect}\ntime_redirect: %{time_redirect}\ntime_pretransfer: %{time_pretransfer}\ntime_starttransfer: %{time_starttransfer}\ntime_total: %{time_total}\n" "https://github.com"

time_namelookup: 0.001451
time_connect: 0.172504
time_appconnect: 0.540843
time_redirect: 0.000000
time_pretransfer: 0.540928
time_starttransfer: 0.724706
time_total: 0.928256
```

å¯è§tlsè€—æ—¶0.368339ï¼Œå æ®æ•´ä½“æ—¶é—´çš„39.6%ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„å æ¯”äº†ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨tlsä¼˜åŒ–éƒ¨åˆ†ä¹Ÿèƒ½å¸¦æ¥å¾ˆå¤§çš„æ”¹å–„

é¦–å…ˆåŠ å¯†ç®—æ³•æ–¹é¢ï¼Œå¯ä»¥ä½¿ç”¨è¾ƒæ–°çš„ECDHEç®—æ³•ï¼Œæµç¨‹

1. client->service: éšæœºæ•°Aã€å¯†ç å¥—ä»¶ç­‰
2. service->client: éšæœºæ•°Bã€ç¡®è®¤å¯†ç å¥—ä»¶ã€è¯ä¹¦ï¼Œä»¥åŠ**Server Key Exchange**ï¼ˆé€‰æ‹©ECDHEç®—æ³•ï¼Œç¡®å®šæ¤­åœ†æ›²çº¿ï¼Œç”Ÿæˆæ¤­åœ†æ›²çº¿çš„ç§é’¥è‡ªå·±ä½¿ç”¨ï¼Œå…¬é’¥å…¬å¼€ï¼‰
3. client->service: ç”Ÿæˆæ¤­åœ†æ›²çº¿ç§é’¥ã€å…¬é’¥ï¼ŒåŒæ ·çš„å°†å…¬é’¥å‘é€ç»™serviceï¼Œå³**Client Key Exchange**ï¼Œè‡³æ­¤ï¼Œè‡ªå·±çš„æ¤­åœ†æ›²çº¿ç§é’¥ã€å…¬é’¥ï¼Œäº‘ç«¯çš„æ¤­åœ†æ›²çº¿å…¬é’¥ï¼Œé€šè¿‡ECDHEç®—æ³•è®¡ç®—å‡º**Pre-Master**ï¼ˆå…·ä½“æµç¨‹æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥äº†è§£ä¸‹ï¼Œè¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„ååˆ†ä¸¥è°¨çš„æ•°å­¦é€»è¾‘ï¼‰ï¼Œè‡³æ­¤ï¼Œå®¢æˆ·ç«¯å·²ç»æœ‰äº†éšæœºæ•°Aã€Bã€Pre-Masterï¼Œç”Ÿæˆ**Master Secret**ï¼ˆå¯¹ç§°åŠ å¯†ç§˜é’¥ï¼‰ï¼Œç„¶å**æå‰å‘å‡ºåŠ å¯†çš„ HTTP æ•°æ®**
4. service->client: åŒæ ·çš„ï¼Œæ‹¥æœ‰è‡ªå·±çš„æ¤­åœ†æ›²çº¿ç§é’¥ã€å…¬é’¥ï¼Œæ”¶åˆ°å®¢æˆ·ç«¯æ¤­åœ†æ›²çº¿å…¬é’¥ï¼Œç”Ÿæˆ**Pre-Master**ï¼Œç„¶åæ ¹æ®éšæœºæ•°Aã€Bã€Pre-Masterç”Ÿæˆ**Master Secret**

å¯è§ä¸»è¦åŒºåˆ«åœ¨äº
1. **Pre-Master**ä¸ç”¨ä¼ è¾“ï¼Œå³å¯ä¿è¯**å‰å‘ä¿å¯†**
2. ECDHEæœ€åå¯ä»¥ä¸ç”¨ç­‰å¾…serviceå›å¤ï¼ŒæŠ¢å…ˆå‘é€æ¶ˆæ¯
3. service key exchangeä»¥åŠclient key exchangeè¿‡ç¨‹

### tls1.3
